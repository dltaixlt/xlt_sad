/*******************************************************************************
This software module was originally developed by

HUAWEI TECHNOLOGIES CO.,LTD

Initial author: Lijing Xu
and edited by: Lijing Xu
-

Function: AAC vs LP mode decision for MPEG USAC Reference Encoder

HUAWEI TECHNOLOGIES CO.,LTD. retain full right to
modify and use the code for its (their) own purpose, assign or donate the code
to a third party and to inhibit third parties from using the code for products
that do not conform to MPEG-related ITU Recommendations and/or ISO/IEC
International Standards. This copyright notice must be included in all copies or
derivative works.

Copyright (c) ISO/IEC 2009.
$Id: signal_classifier.c,v 1.1 2011-01-20 21:15:06 mul Exp $
*******************************************************************************/

#include "signal_classifier.h"
#include <string.h>
#include <math.h>

//hanning window
const double hanning_window[FRAMELEN]=
{
	0,                0.000015370317393,0.000061480690889,0.000138329384457,0.000245913504789,
	0.000384229001402,0.000553270666797,0.00075303213665, 0.000983505890054,0.001244683249805,
	0.00153655438272, 0.001859108300018,0.002212332857725,0.002596214757137,0.003010739545316,
	0.00345589161564, 0.003931654208384,0.004438009411355,0.004974938160566,0.005542420240954,
	0.006140434287139,0.006768957784229,0.007427967068671,0.008117437329137,0.008837342607462,
	0.009587655799618,0.010368348656739,0.01117939178618, 0.012020754652625,0.012892405579237,
	0.013794311748852,0.014726439205213,0.015688752854247,0.01668121646539, 0.017703792672947,
	0.018756442977503,0.019839127747368,0.020951806220072,0.022094436503901,0.023266975579469,
	0.024469379301344,0.025701602399704,0.026963598482046,0.028255320034932,0.029576718425774,
	0.030927743904671,0.032308345606277,0.033718471551717,0.035158068650547,0.03662708270275,
	0.038125458400778,0.039653139331631,0.041210067978987,0.042796185725362,0.044411432854319,
	0.046055748552716,0.047729070912998,0.049431336935522,0.051162482530936,0.052922442522585,
	0.054711150648972,0.056528539566246,0.058374540850741,0.060249085001554,0.062152101443155,
	0.064083518528051,0.066043263539481,0.068031262694153,0.070047441145022,0.072091722984109,
	0.074164031245358,0.076264287907535,0.078392413897163,0.080548329091501,0.082731952321562,
	0.084943201375164,0.08718199300003, 0.089448242906922,0.091741865772811,0.094062775244093,
	0.096410883939837,0.098786103455079,0.101188344364146,0.103617516224025,0.10607352757777,
	0.108556285957941,0.111065697890088,0.11360166889627, 0.116164103498613,0.118752905222901,
	0.121367976602213,0.12400921918059, 0.126676533516741,0.129369819187789,0.132088974793051,
	0.134833897957855,0.137604485337396,0.140400632620624,0.143222234534175,0.146069184846332,
	0.148941376371024,0.151838700971864,0.154761049566218,0.157708312129314,0.160680377698381,
	0.16367713437683, 0.166698469338468,0.169744268831739,0.172814418184015,0.175908801805908,
	0.179027303195622,0.182169804943345,0.18533618873566, 0.188526335360008,0.191740124709171,
	0.194977435785797,0.198238146706954,0.201522134708718,0.204829276150797,0.208159446521186,
	0.211512520440851,0.214888371668455,0.218286873105108,0.22170789679915, 0.225151313950974,
	0.22861699491787, 0.232104809218908,0.235614625539852,0.2391463117381,  0.242699734847664,
	0.246274761084171,0.249871255849904,0.253489083738869,0.25712810854189, 0.26078819325174,
	0.264469200068298,0.268170990403738,0.271893424887747,0.27563636337277, 0.279399664939288,
	0.283183187901125,0.286986789810779,0.290810327464789,0.294653656909122,0.298516633444598,
	0.302399111632333,0.306300945299219,0.310221987543421,0.314162090739918,0.318121106546049,
	0.322098885907107,0.326095279061949,0.33011013554863, 0.334143304210072,0.338194633199756,
	0.342263969987435,0.346351161364878,0.35045605345164, 0.354578491700855,0.358718320905051,
	0.362875385202001,0.367049528080581,0.371240592386673,0.375448420329074,0.37967285348544,
	0.38391373280825, 0.388170898630795,0.392444190673188,0.396733448048399,0.401038509268312,
	0.405359212249804,0.409695394320852,0.41404689222665, 0.418413542135763,0.422795179646288,
	0.427191639792051,0.431602757048812,0.436028365340499,0.440468298045461,0.444922388002741,
	0.449390467518371,0.453872368371681,0.458367921821638,0.462876958613196,0.467399308983666,
	0.471934802669115,0.476483268910768,0.481044536461443,0.485618433591993,0.490204788097777,
	0.494803427305141,0.499414178077916,0.504036866823943,0.508671319501604,0.513317361626373,
	0.517974818277392,0.522643514104049,0.527323273332586,0.532013919772712,0.53671527682424,
	0.541427167483736,0.546149414351177,0.550881839636639,0.555624265166984,0.560376512392572,
	0.565138402393982,0.569909755888744,0.574690393238098,0.579480134453749,0.584278799204648,
	0.589086206823778,0.59390217631496, 0.598726526359666,0.603559075323841,0.60839964126475,
	0.61324804193782, 0.618104094803507,0.622967617034165,0.62783842552093, 0.632716336880616,
	0.637601167462617,0.642492733355824,0.647390850395544,0.652295334170439,0.657206000029468,
	0.662122663088837,0.667045138238959,0.671973240151429,0.676906783285994,0.681845581897543,
	0.686789450043102,0.691738201588827,0.69669165021702, 0.701649609433141,0.706611892572826,
	0.711578312808922,0.716548683158512,0.721522816489962,0.726500525529963,0.731481622870585,
	0.736465920976327,0.741453232191182,0.746443368745703,0.751436142764068,0.756431366271157,
	0.76142885119963, 0.766428409397002,0.771429852632734,0.776432992605314,0.78143764094935,
	0.786443609242662,0.791450709013371,0.796458751747002,0.801467548893576,0.806476911874712,
	0.811486652090724,0.816496580927726,0.821506509764728,0.82651624998074, 0.831525612961876,
	0.83653441010845, 0.841542452842081,0.84654955261279, 0.851555520906101,0.856560169250138,
	0.861563309222718,0.86656475245845, 0.871564310655822,0.876561795584295,0.881557019091384,
	0.886549793109749,0.89153992966427, 0.896527240879125,0.901511538984867,0.906492636325489,
	0.91147034536549, 0.91644447869694, 0.92141484904653, 0.926381269282625,0.931343552422311,
	0.936301511638432,0.941254960266625,0.94620371181235, 0.951147579957909,0.956086378569458,
	0.961019921704023,0.965948023616493,0.970870498766615,0.975787161825984,0.980697827685013,
	0.985602311459908,0.990500428499628,0.995391994392835,1.000276824974836,1.005154736334522,
	1.010025544821287,1.014889067051945,1.019745119917632,1.024593520590702,1.029434086531611,
	1.034266635495786,1.039090985540492,1.043906955031674,1.048714362650804,1.053513027401703,
	1.058302768617354,1.063083405966708,1.06785475946147, 1.07261664946288, 1.077368896688468,
	1.082111322218813,1.086843747504275,1.091565994371717,1.096277885031211,1.10097924208274,
	1.105669888522866,1.110349647751403,1.11501834357806, 1.119675800229079,1.124321842353848,
	1.128956295031508,1.133578983777536,1.138189734550311,1.142788373757675,1.147374728263459,
	1.151948625394009,1.156509892944684,1.161058359186337,1.165593852871786,1.170116203242256,
	1.174625240033814,1.179120793483771,1.183602694337081,1.18807077385271, 1.192524863809992,
	1.196964796514953,1.20139040480664, 1.205801522063401,1.210197982209164,1.214579619719689,
	1.218946269628802,1.2232977675346,  1.227633949605648,1.23195465258714, 1.236259713807053,
	1.240548971182264,1.244822263224656,1.249079429047202,1.253320308370012,1.257544741526378,
	1.261752569468779,1.265943633774871,1.270117776653451,1.274274840950401,1.278414670154597,
	1.282537108403812,1.286642000490574,1.290729191868017,1.294798528655696,1.298849857645379,
	1.302883026306822,1.306897882793503,1.310894275948344,1.314872055309404,1.318831071115534,
	1.322771174312031,1.326692216556233,1.330594050223119,1.334476528410854,1.33833950494633,
	1.342182834390663,1.346006372044673,1.349809973954327,1.353593496916164,1.357356798482682,
	1.361099736967705,1.364822171451714,1.368523961787154,1.372204968603712,1.375865053313562,
	1.379504078116583,1.383121906005548,1.386718400771281,1.390293427007788,1.393846850117352,
	1.3973785363156,  1.400888352636544,1.404376166937582,1.407841847904478,1.411285265056302,
	1.414706288750344,1.418104790186997,1.421480641414601,1.424833715334266,1.428163885704655,
	1.431471027146734,1.434755015148498,1.438015726069655,1.441253037146281,1.444466826495444,
	1.447656973119792,1.450823356912107,1.45396585865983, 1.457084360049544,1.460178743671437,
	1.463248893023713,1.466294692516984,1.469316027478622,1.472312784157071,1.475284849726139,
	1.478232112289234,1.481154460883588,1.484051785484428,1.48692397700912, 1.489770927321276,
	1.492592529234828,1.495388676518056,1.498159263897597,1.500904187062401,1.503623342667663,
	1.506316628338712,1.508983942674862,1.511625185253239,1.514240256632551,1.516829058356839,
	1.519391492959181,1.521927463965364,1.524436875897511,1.526919634277682,1.529375645631426,
	1.531804817491306,1.534207058400374,1.536582277915615,1.53893038661136, 1.541251296082641,
	1.54354491894853, 1.545811168855422,1.548049960480288,1.55026120953389, 1.552444832763951,
	1.55460074795829, 1.556728873947918,1.558829130610094,1.560901438871343,1.56294572071043,
	1.5649618991613,  1.566949898315971,1.568909643327401,1.570841060412298,1.572744076853898,
	1.574618621004711,1.576464622289206,1.57828201120648,1.580070719332867, 1.581830679324516,
	1.58356182491993, 1.585264090942454,1.586937413302736,1.588581729001133,1.59019697613009,
	1.591783093876465,1.593340022523821,1.594867703454674,1.596366079152702,1.597835093204905,
	1.599274690303735,1.600684816249176,1.602065417950781,1.603416443429678,1.60473784182052,
	1.606029563373406,1.607291559455748,1.608523782554108,1.609726186275983,1.610898725351551,
	1.612041355635379,1.613154034108084,1.614236718877949,1.615289369182504,1.616311945390062,
	1.617304409001205,1.618266722650239,1.6191988501066,  1.620100756276215,1.620972407202827,
	1.621813770069272,1.622624813198712,1.623405506055834,1.624155819247991,1.624875724526315,
	1.625565194786781,1.626224204071223,1.626852727568314,1.627450741614498,1.628018223694886,
	1.628555152444097,1.629061507647068,1.629537270239812,1.629982422310136,1.630396947098315,
	1.630780828997727,1.631134053555434,1.631456607472732,1.631748478605648,1.632009655965398,
	1.632240129718802,1.632439891188656,1.63260893285405, 1.632747248350663,1.632854832470995,
	1.632931681164564,1.632977791538059,1.632993161855452,1.632977791538059,1.632931681164564,
	1.632854832470995,1.632747248350663,1.63260893285405, 1.632439891188656,1.632240129718802,
	1.632009655965398,1.631748478605648,1.631456607472732,1.631134053555434,1.630780828997727,
	1.630396947098315,1.629982422310136,1.629537270239812,1.629061507647068,1.628555152444097,
	1.628018223694886,1.627450741614498,1.626852727568314,1.626224204071223,1.625565194786781,
	1.624875724526315,1.624155819247991,1.623405506055834,1.622624813198712,1.621813770069272,
	1.620972407202827,1.620100756276215,1.6191988501066,  1.618266722650239,1.617304409001205,
	1.616311945390062,1.615289369182504,1.614236718877949,1.613154034108084,1.612041355635379,
	1.610898725351551,1.609726186275983,1.608523782554108,1.607291559455748,1.606029563373406,
	1.60473784182052, 1.603416443429678,1.602065417950781,1.600684816249176,1.599274690303735,
	1.597835093204905,1.596366079152702,1.594867703454674,1.593340022523821,1.591783093876465,
	1.59019697613009, 1.588581729001133,1.586937413302736,1.585264090942454,1.58356182491993,
	1.581830679324516,1.580070719332867,1.57828201120648, 1.576464622289206,1.574618621004711,
	1.572744076853898,1.570841060412298,1.568909643327401,1.566949898315971,1.5649618991613,
	1.56294572071043, 1.560901438871343,1.558829130610094,1.556728873947918,1.55460074795829,
	1.552444832763951,1.55026120953389, 1.548049960480288,1.545811168855422,1.54354491894853,
	1.541251296082641,1.53893038661136, 1.536582277915615,1.534207058400374,1.531804817491306,
	1.529375645631426,1.526919634277682,1.524436875897511,1.521927463965364,1.519391492959181,
	1.516829058356839,1.514240256632551,1.511625185253239,1.508983942674862,1.506316628338712,
	1.503623342667663,1.500904187062401,1.498159263897597,1.495388676518056,1.492592529234828,
	1.489770927321276,1.48692397700912, 1.484051785484428,1.481154460883588,1.478232112289234,
	1.475284849726139,1.472312784157071,1.469316027478622,1.466294692516984,1.463248893023713,
	1.460178743671437,1.457084360049544,1.45396585865983, 1.450823356912107,1.447656973119792,
	1.444466826495444,1.441253037146281,1.438015726069655,1.434755015148498,1.431471027146734,
	1.428163885704655,1.424833715334266,1.421480641414601,1.418104790186997,1.414706288750344,
	1.411285265056302,1.407841847904478,1.404376166937582,1.400888352636544,1.3973785363156,
	1.393846850117352,1.390293427007788,1.386718400771281,1.383121906005548,1.379504078116583,
	1.375865053313562,1.372204968603712,1.368523961787154,1.364822171451714,1.361099736967705,
	1.357356798482682,1.353593496916164,1.349809973954327,1.346006372044673,1.342182834390663,
	1.33833950494633, 1.334476528410854,1.330594050223119,1.326692216556233,1.322771174312031,
	1.318831071115534,1.314872055309404,1.310894275948344,1.306897882793503,1.302883026306822,
	1.298849857645379,1.294798528655696,1.290729191868017,1.286642000490574,1.282537108403812,
	1.278414670154597,1.274274840950401,1.270117776653451,1.265943633774871,1.261752569468779,
	1.257544741526378,1.253320308370012,1.249079429047202,1.244822263224656,1.240548971182264,
	1.236259713807053,1.23195465258714, 1.227633949605648,1.2232977675346,  1.218946269628802,
	1.214579619719689,1.210197982209164,1.205801522063401,1.20139040480664, 1.196964796514953,
	1.192524863809992,1.18807077385271, 1.183602694337081,1.179120793483771,1.174625240033814,
	1.170116203242256,1.165593852871786,1.161058359186337,1.156509892944684,1.151948625394009,
	1.147374728263459,1.142788373757675,1.138189734550311,1.133578983777536,1.128956295031508,
	1.124321842353848,1.119675800229079,1.11501834357806, 1.110349647751403,1.105669888522866,
	1.10097924208274, 1.096277885031211,1.091565994371717,1.086843747504275,1.082111322218813,
	1.077368896688468,1.07261664946288, 1.06785475946147, 1.063083405966708,1.058302768617354,
	1.053513027401703,1.048714362650804,1.043906955031674,1.039090985540492,1.034266635495786,
	1.029434086531611,1.024593520590702,1.019745119917632,1.014889067051945,1.010025544821287,
	1.005154736334522,1.000276824974836,0.995391994392835,0.990500428499628,0.985602311459908,
	0.980697827685013,0.975787161825984,0.970870498766615,0.965948023616493,0.961019921704023,
	0.956086378569458,0.951147579957909,0.94620371181235, 0.941254960266625,0.936301511638432,
	0.931343552422311,0.926381269282625,0.92141484904653, 0.91644447869694, 0.91147034536549,
	0.906492636325489,0.901511538984867,0.896527240879125,0.89153992966427, 0.886549793109749,
	0.881557019091384,0.876561795584295,0.871564310655822,0.86656475245845, 0.861563309222718,
	0.856560169250138,0.851555520906101,0.84654955261279, 0.841542452842081,0.83653441010845,
	0.831525612961876,0.82651624998074, 0.821506509764728,0.816496580927726,0.811486652090724,
	0.806476911874712,0.801467548893576,0.796458751747002,0.791450709013371,0.786443609242662,
	0.78143764094935, 0.776432992605314,0.771429852632734,0.766428409397002,0.76142885119963,
	0.756431366271157,0.751436142764068,0.746443368745703,0.741453232191182,0.736465920976327,
	0.731481622870585,0.726500525529963,0.721522816489962,0.716548683158512,0.711578312808922,
	0.706611892572826,0.701649609433141,0.69669165021702, 0.691738201588827,0.686789450043102,
	0.681845581897543,0.676906783285994,0.671973240151429,0.667045138238959,0.662122663088837,
	0.657206000029468,0.652295334170439,0.647390850395544,0.642492733355824,0.637601167462617,
	0.632716336880616,0.62783842552093, 0.622967617034165,0.618104094803507,0.61324804193782,
	0.60839964126475, 0.603559075323841,0.598726526359666,0.59390217631496, 0.589086206823778,
	0.584278799204648,0.579480134453749,0.574690393238098,0.569909755888744,0.565138402393982,
	0.560376512392572,0.555624265166984,0.550881839636639,0.546149414351177,0.541427167483736,
	0.53671527682424,0.532013919772712,0.527323273332586,0.522643514104049,0.517974818277392,
	0.513317361626373,0.508671319501604,0.504036866823943,0.499414178077916,0.494803427305141,
	0.490204788097777,0.485618433591993,0.481044536461443,0.476483268910768,0.471934802669115,
	0.467399308983666,0.462876958613196,0.458367921821638,0.453872368371681,0.449390467518371,
	0.444922388002741,0.440468298045461,0.436028365340499,0.431602757048812,0.427191639792051,
	0.422795179646288,0.418413542135763,0.41404689222665, 0.409695394320852,0.405359212249804,
	0.401038509268312,0.396733448048399,0.392444190673188,0.388170898630795,0.38391373280825,
	0.37967285348544, 0.375448420329074,0.371240592386673,0.367049528080581,0.362875385202001,
	0.358718320905051,0.354578491700855,0.35045605345164, 0.346351161364878,0.342263969987435,
	0.338194633199756,0.334143304210072,0.33011013554863, 0.326095279061949,0.322098885907107,
	0.318121106546049,0.314162090739918,0.310221987543421,0.306300945299219,0.302399111632333,
	0.298516633444598,0.294653656909122,0.290810327464789,0.286986789810779,0.283183187901125,
	0.279399664939288,0.27563636337277, 0.271893424887747,0.268170990403738,0.264469200068298,
	0.26078819325174, 0.25712810854189, 0.253489083738869,0.249871255849904,0.246274761084171,
	0.242699734847664,0.2391463117381,  0.235614625539852,0.232104809218908,0.22861699491787,
	0.225151313950974,0.22170789679915, 0.218286873105108,0.214888371668455,0.211512520440851,
	0.208159446521186,0.204829276150797,0.201522134708718,0.198238146706954,0.194977435785797,
	0.191740124709171,0.188526335360008,0.18533618873566, 0.182169804943345,0.179027303195622,
	0.175908801805908,0.172814418184015,0.169744268831739,0.166698469338468,0.16367713437683,
	0.160680377698381,0.157708312129314,0.154761049566218,0.151838700971864,0.148941376371024,
	0.146069184846332,0.143222234534175,0.140400632620624,0.137604485337396,0.134833897957855,
	0.132088974793051,0.129369819187789,0.126676533516741,0.12400921918059, 0.121367976602213,
	0.118752905222901,0.116164103498613,0.11360166889627, 0.111065697890088,0.108556285957941,
	0.10607352757777, 0.103617516224025,0.101188344364146,0.098786103455079,0.096410883939837,
	0.094062775244093,0.091741865772811,0.089448242906922,0.08718199300003, 0.084943201375164,
	0.082731952321562,0.080548329091501,0.078392413897163,0.076264287907535,0.074164031245358,
	0.072091722984109,0.070047441145022,0.068031262694153,0.066043263539481,0.064083518528051,
	0.062152101443155,0.060249085001554,0.058374540850741,0.056528539566246,0.054711150648972,
	0.052922442522585,0.051162482530936,0.049431336935522,0.047729070912998,0.046055748552716,
	0.044411432854319,0.042796185725362,0.041210067978987,0.039653139331631,0.038125458400778,
	0.03662708270275, 0.035158068650547,0.033718471551717,0.032308345606277,0.030927743904671,
	0.029576718425774,0.028255320034932,0.026963598482046,0.025701602399704,0.024469379301344,
	0.023266975579469,0.022094436503901,0.020951806220072,0.019839127747368,0.018756442977503,
	0.017703792672947,0.01668121646539, 0.015688752854247,0.014726439205213,0.013794311748852,
	0.012892405579237,0.012020754652625,0.01117939178618, 0.010368348656739,0.009587655799618,
	0.008837342607462,0.008117437329137,0.007427967068671,0.006768957784229,0.006140434287139,
	0.005542420240954,0.004974938160566,0.004438009411355,0.003931654208384,0.00345589161564,
	0.003010739545316,0.002596214757137,0.002212332857725,0.001859108300018,0.00153655438272,
	0.001244683249805,0.000983505890054,0.00075303213665, 0.000553270666797,0.000384229001402,
	0.000245913504789,0.000138329384457,0.000061480690889,0.000015370317393
};

/*===================================================================================
 * Function: FFT_complex
 *		The conventional complex FFT without speeding techniques.
 *      For specific DSP, they may have special FFT routines.
 * Arguments:
 *		float *x: Input real data array
 *		float *y: Input image data array
 *		int n: The size of FFT = log2(N)
 *		int direction: +1 = forward FFT, -1 = inverse FFT
 * Return:
 *		None (output replace in x and y)
 *===================================================================================*/
void FFT_complex(float *x, float *y, int n, int direction)
{
	register int i, j, k;
	int N;
	float *real, *image;
	float temp;
	int le,le1,ip;
	float tx,ty,ux,uy;

	//Set data array according to direction
	if (direction == 1)
	{
		//FFT
		real = x;
		image = y;
	}
	else if (direction == -1)
	{
		//Inverse FFT
		real = y;
		image = x;
	}

	//Determine the size of the FFT
	N = 1;
	N = N << n;

	//Bit reversal
	j = 0;
	for (i = 0; i < N - 1; i++)
	{
		if (i < j)
		{
			//swap real
			temp = real[i];
			real[i] = real[j];
			real[j] = temp;
			
			//swap image
			temp = image[i];
			image[i] = image[j];
			image[j] = temp;
		}
		k = N / 2;
		while (k <= j)
		{
			j -= k;
			k /= 2;
		}
		j += k;
	}

	//FFT main loop
	for (k = 0; k < n; k++)
	{
		le1 = 1;
		le1 = le1 << k;
		le = le1 * 2;
		ux = 1.0;
		uy = 0.0;
		for (j = 0; j < le1; j++)
		{
			ux = (float)cos(j * PI / (float)le1);
			uy = - (float)sin( j * PI /(float)le1);
			for (i = j; i < N; i += le)
			{
				ip = i + le1;
				tx = real[ip]*ux - image[ip]*uy;
				ty = real[ip]*uy + image[ip]*ux;
				real[ip]  = real[i]  - tx;
				image[ip] = image[i] - ty;
				real[i]  = real[i]  + tx;
				image[i] = image[i] + ty;
			}
		}
	}
}

/*===================================================================================
 * Function: find_tonal_components
 *		Find tonal components.
 * Arguments:
 *		double psd[FRAMELEN/2]: power density spectrum
 *		int tonal_num_fr[4]:	number of tonal components in each frequency region
 * Return:
 *		None (output replace in tonal_num_fr)
 *===================================================================================*/
void find_tonal_components(double psd[FRAMELEN/2], int tonal_num_fr[4])
{
	int i, j;
	int is_tonal;	

	for(i = 0; i < 4; i++)
	{
		tonal_num_fr[i] = 0;
	}

    for (i = 2; i < 500; i++)
    {
		//A spectral line is local maximum if psd[i-1]<psd[i]<=psd[i+1]
		if ((psd[i] > psd[i - 1]) && (psd[i] >= psd[i + 1]))
		{
			is_tonal = 1;

			//A local maximum is tonal component if psd(k)-psd(k+j)>=7dB
			//the first frequency region: 0kHz ~ 4kHz (j=-2,+2)
			if ((2 <= i) && (i < 62))
			{
				is_tonal = is_tonal && (psd[i] - psd[i - 2] >= 7);		
				if (is_tonal == 1)
				{					
					is_tonal = is_tonal && (psd[i] - psd[i + 2] >= 7);					
				}

				//count the number of tonal components in the first frequency region
				if (is_tonal == 1)
				{
					tonal_num_fr[0]++;
				}
			}

			//the second frequency region: 0kHz ~ 4kHz (j=-3,-2,+2,+3)
			else if((62 <= i) && (i < 126))
			{
				for (j = -3; j <= -2; j++)
				{
					is_tonal = is_tonal && (psd[i] - psd[i + j] >= 7);
					if (is_tonal == 0)
					{
						break;
					}
				}
				if (is_tonal == 1)
				{
					for (j = 2; j <= 3; j++)
					{
						is_tonal = is_tonal && (psd[i] - psd[i + j] >= 7);
						if (is_tonal == 0)
						{
							break;
						}
					}
				}

				//count the number of tonal components in the second frequency region
				if (is_tonal == 1)
				{
					tonal_num_fr[1]++;
				}
			}

			//the third frequency region: 0kHz ~ 4kHz (j=-6,...,-2,+2,...,+6)
			else if((126 <= i) && (i < 254))
			{
				for (j = -6; j <= -2; j++)
				{
					is_tonal = is_tonal && (psd[i] - psd[i + j] >= 7);
					if (is_tonal == 0)
					{
						break;
					}
				}
				if (is_tonal == 1)
				{
					for (j = 2; j <= 6; j++)
					{
						is_tonal = is_tonal && (psd[i] - psd[i + j] >= 7);
						if (is_tonal == 0)
						{
							break;
						}
					}
				}

				//count the number of tonal components in the third frequency region
				if (is_tonal == 1)
				{
					tonal_num_fr[2]++;
				}
			}

			//the fourth frequency region: 0kHz ~ 4kHz (j=-12,...,-2,+2,...,+12)
			else
			{
				for (j = -12; j <= -2; j++)
				{
					is_tonal = is_tonal && (psd[i] - psd[i + j] >= 7);
					if (is_tonal == 0)
					{
						break;
					}
				}
				if (is_tonal == 1)
				{
					for (j = 2; j <= 12; j++)
					{
						is_tonal = is_tonal && (psd[i] - psd[i + j]>=7);
						if (is_tonal == 0)
						{
							break;
						}
					}
				}

				//count the number of tonal components in the fourth frequency region
				if (is_tonal == 1)
				{
					tonal_num_fr[3]++;
				}
			}			
		}
    }
}

/*===================================================================================
 * Function: tonal_analysis
 *		Tonal analysis.
 * Arguments:
 *		float time_signal[FRAMELEN]:	the original input signal of the current frame
 *		int framecnt:					frame counter
 *		CLASSIFICATION *classfy:		
 *		float *ave_num_tonal:			running average of the number of tonal components
 *		float ratio_num_tonal_fb[4]:	ratio of the tonal components between a frequency region and the full band
 * Return:
 *		None (output replace in ave_num_tonal and ratio_num_tonal_fb)
 *===================================================================================*/
void tonal_analysis (float time_signal[FRAMELEN], int framecnt, CLASSIFICATION *classfy, 
					 float *ave_num_tonal, float ratio_num_tonal_fb[4])
{
	int i,j;

	float real_data[FRAMELEN];
    float image_data[FRAMELEN];
	int fft_size=10;
	int fft_direction=1;	//forward FFT

	double psd[FRAMELEN/2];	//power density spectrum
	int tonal_num_fr[4];
	int tonal_num_total;

	//FFT analysis
	for (i = 0; i < FRAMELEN; i++)
	{
		real_data[i] = (float)(time_signal[i] * hanning_window[i]);
		image_data[i] = 0;
	}	
	FFT_complex(real_data, image_data, fft_size, fft_direction);
	
	//power density spectrum
	for (i = 0; i < FRAMELEN / 2; i++)
	{
		psd[i] = max(20 * log10(sqrt(pow(real_data[i], 2) + pow(image_data[i], 2)) / FRAMELEN), MIN_POW);
	}
		
	//find tonal components
	find_tonal_components(psd, tonal_num_fr);

	//update the number buffer of the tonal components 
	for(i = 0; i < 4; i++)
	{
		for(j = 0; j < N_TONAL_BUFF - 1; j++)
		{
			classfy->tonal_num_fr_buf[i][j] = classfy->tonal_num_fr_buf[i][j + 1];
		}
		classfy->tonal_num_fr_buf[i][N_TONAL_BUFF - 1] = tonal_num_fr[i];
	}

	//the running average of the numbers of tonal components
	tonal_num_total = 0;
	for(i = 0; i < N_TONAL_BUFF; i++)
	{
		for(j = 0; j < 4; j++)
		{
			tonal_num_total += classfy->tonal_num_fr_buf[j][i];
		}
	}

	if(framecnt < N_TONAL_BUFF)
	{
		*ave_num_tonal = (float)tonal_num_total / framecnt;
	}
	else
	{
		*ave_num_tonal = (float)tonal_num_total / N_TONAL_BUFF;
	}

	//ratio of the tonal components between a frequency region and the full band
	for(i = 0; i < 4; i++)
	{
		ratio_num_tonal_fb[i] = 0;
		for(j = 0; j < N_TONAL_BUFF; j++)
		{
			ratio_num_tonal_fb[i] += classfy->tonal_num_fr_buf[i][j];
		}
		ratio_num_tonal_fb[i] /= tonal_num_total;
	}
}

/*===================================================================================
 * Function: spectral_tilt_analysis
 *		Spectral tilt analysis.
 * Arguments:
 *		float time_signal[FRAMELEN]:	the original input signal of the current frame
 *		int framecnt:					frame counter
 *		CLASSIFICATION *classfy:
 *		float *msd_spec_tilt:			mean square deviation of the spectral tilt
 *		float *r0:						
 * Return:
 *		None (output replace in msd_spec_tilt and r0)
 *===================================================================================*/
void spectral_tilt_analysis(float time_signal[FRAMELEN], int framecnt, CLASSIFICATION *classfy,
							float *msd_spec_tilt, float *r0)
{
	int i;

	int ave_length;
	
	float r1;
	float spec_tilt;
	float ave_spec_tilt;

	//spectral tilt
	*r0 = 0;
	for (i = 0; i < FRAMELEN; i++)
	{
		*r0 += time_signal[i] * time_signal[i];
	}

	r1 = 0;
	for (i = 0; i < FRAMELEN - 1; i++)
	{
		r1 += time_signal[i] * time_signal[i + 1];
	}

	if (*r0 == 0)
	{
		spec_tilt = 1.0f;
	}
	else
	{
		spec_tilt = r1 / (*r0);
	}
        
	//update spectral tilt buffer
	for (i = 0; i < N_TILT_BUFF - 1; i++)
	{
		classfy->spec_tilt_buf[i] = classfy->spec_tilt_buf[i + 1];
	}
	classfy->spec_tilt_buf[N_TILT_BUFF - 1] = spec_tilt;
		
	//the running average of the spectral tilt
	if(framecnt < N_TILT_BUFF)
	{
		ave_length = framecnt;
	}
	else
	{
		ave_length = N_TILT_BUFF;
	}
	
	ave_spec_tilt = 0;
	for(i = 0; i < ave_length; i++)
	{
		ave_spec_tilt += classfy->spec_tilt_buf[N_TILT_BUFF - 1 - i];
	}
	ave_spec_tilt /= ave_length;

	//mean square deviation
	*msd_spec_tilt = 0;
	for(i = 0; i < ave_length; i++)
	{
		*msd_spec_tilt += (classfy->spec_tilt_buf[N_TILT_BUFF - 1 - i] - ave_spec_tilt)
				* (classfy->spec_tilt_buf[N_TILT_BUFF - 1 - i] - ave_spec_tilt);
	}
	*msd_spec_tilt /= ave_length;
}

/*===================================================================================
 * Function: mode_decision
 *		Coding mode decision.
 * Arguments:
 *		int ener:						time signal energy of the frame
 *		float ave_num_tonal:			running average of the number of tonal components
 *		float ratio_num_tonal_fb[4]:	ratio of the tonal components between a frequency region and the full band
 *		float msd_spec_tilt:			mean square deviation of the spectral tilt
 *		CLASSIFICATION *classfy:
 * Return:
 *		None (output replace in classfy->coding_mode and classfy->pre_mode)
 *===================================================================================*/
void mode_decision(int ener, float ave_num_tonal, float ratio_num_tonal_fb[4], 
				   float msd_spec_tilt, CLASSIFICATION *classfy)
{
	int i;

	int avg_cls;
	static int class_buf[N_SMOOTH];

	classfy->coding_mode = FD_MODE;	//default FD mode

	//step 1
	if ((ratio_num_tonal_fb[0] >= 0.6) && (ratio_num_tonal_fb[2] <= 0.1459))
	{
		classfy->coding_mode = TD_MODE;	//TD mode
		if (ener > 10)
		{
			classfy->coding_mode = classfy->pre_mode;
		}            
	}

	//step 2
	if (msd_spec_tilt >= 0.0021)
	{
		classfy->coding_mode = TD_MODE;	//TD mode
		if (ener > 21)
		{
			classfy->coding_mode = classfy->pre_mode;
		}  
	}
	if (msd_spec_tilt < 0.00012)
	{
		classfy->coding_mode = FD_MODE;	//FD mode
	}

	//step 3
	avg_cls = 0;
	for (i=0; i<N_SMOOTH-1; i++)
	{
		class_buf[i] = class_buf[i + 1];
		if (class_buf[i] == FD_MODE)
		{
			avg_cls += 1;
		}
	}
	class_buf[N_SMOOTH - 1] = classfy->coding_mode;
	if (class_buf[N_SMOOTH - 1] == FD_MODE)
	{
		avg_cls += 1;
	}

	if ((avg_cls <= (N_SMOOTH / 2)) && (classfy->coding_mode == FD_MODE))
	{
		classfy->coding_mode = TD_MODE;	//TD mode
	}

	//step 4
	if (ave_num_tonal > 17)
	{
		classfy->coding_mode = FD_MODE;	//FD mode
	}
}

/*===================================================================================
 * Function: classification
 *		Analyse original input signal to generate coding mode.
 * Arguments:
 *		CLASSIFICATION *classfy:
 * Return:
 *		None (output replace in classfy->coding_mode)
 *===================================================================================*/
void classification (CLASSIFICATION *classfy)
{
	float time_signal[FRAMELEN];
	static int framecnt = 0;

	float ave_num_tonal;
	float ratio_num_tonal_fb[4];

	float msd_spec_tilt;
	float r0;

	int ener = 0;

	int nf;
	int i;

	framecnt++;

	for (i = 0; i < FRAMELEN; i++)
	{
		time_signal[i] = classfy->input_samples[i];            
	}

	//tonal analysis
	tonal_analysis (time_signal, framecnt,classfy, &ave_num_tonal, ratio_num_tonal_fb);

	//spectral tilt analysis
	spectral_tilt_analysis (time_signal, framecnt, classfy, &msd_spec_tilt, &r0);
        
	//input signal energy
	ener = (int)max(10 * log10(sqrt(r0) / FRAMELEN), MIN_POW);

	//coding mode decision
	mode_decision(ener, ave_num_tonal, ratio_num_tonal_fb, msd_spec_tilt, classfy);
	
	classfy->pre_mode = classfy->coding_mode;
}

/*===================================================================================
 * Function: init_classification
 *		
 * Arguments:
 *		CLASSIFICATION *classfy:
 * Return:
 *		None (output replace in classfy)
 *===================================================================================*/
void init_classification(CLASSIFICATION *classfy)
{
	int i,j;

	for (i = 0; i < 4; i++)
	{
		for (j = 0; j < N_TONAL_BUFF; j++)
		{
			classfy->tonal_num_fr_buf[i][j] = 0;
		}
	}

	for (i = 0; i < N_TILT_BUFF; i++)
	{
		classfy->spec_tilt_buf[i] = 0;
	}

	classfy->pre_mode = FD_MODE;		//default FD mode

	memset(classfy->input_samples, 0, FRAMELEN * sizeof(float));
}